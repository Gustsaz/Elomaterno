<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EloMaterno - Fórum</title>
  <link rel="stylesheet" href="./css/header.css">
  <link rel="stylesheet" href="./css/globals.css">
  <link rel="stylesheet" href="./css/forum.css">
  <script type="module" src="/firebase-config.js"></script>
  <link rel="icon" type="image/svg+xml" href="img/iconelogo.svg">
  <link rel="alternate icon" type="image/png" href="img/iconelogo.png">
</head>

<body>
  <header class="top-header">
    <div class="left-section">
      <div class="logo-area">
        <a href="home.html" class="botao-link">
          <img src="./img/logo_icon.png" alt="Ícone Empresa" class="icon">
        </a>
        <span class="company-name">elomaterno</span>
      </div>

      <div class="search-box">
        <input type="text" placeholder="Pesquisar...">
        <button class="btn-search">
          <img src="./img/pesquisa_icon.png" alt="Ícone Buscar">
        </button>
        <button class="btn-voice">
          <img src="./img/microfone_icon.png" alt="Ícone Microfone">
        </button>
      </div>
    </div>

    <div class="user-avatar">
      <a href="perfil.html">
        <img src="./img/account_icon.png" alt="Avatar Usuário">
      </a>
    </div>
  </header>

  <div class="botoes">
    <a href="consultoria.html" class="botao-link">
      <div class="botao-item"><img src="./img/consult_icon.png"></div>
    </a>
    <a href="forum.html" class="botao-link">
      <div class="botao-item"><img src="./img/forum_icon.png"></div>
    </a>
    <a href="home.html" class="botao-link home-btn">
      <div class="botao-item"><img src="./img/home_icon.png"></div>
    </a>
    <a href="artigos.html" class="botao-link">
      <div class="botao-item"><img src="./img/artigo_icon.png"></div>
    </a>
    <a href="calendario.html" class="botao-link">
      <div class="botao-item"><img src="./img/calend_icon.png"></div>
    </a>
    <a href="eventos.html" class="botao-link">
      <div class="botao-item"><img src="./img/agenda_icon.png"></div>
    </a>
  </div>

  <main class="forum-container">
    <div class="forum-search">
      <input type="text" placeholder="Pesquisar no fórum">
      <button class="add-post-btn">+</button>
    </div>
  </main>

  <button class="botao-nova">Nova Publicação</button>

  <script src="./js/globals.js"></script>

  <script type="module">
    import { auth, db } from "./js/firebase.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import {
      collection, addDoc, serverTimestamp, query, orderBy, onSnapshot,
      doc, getDoc, setDoc, deleteDoc, updateDoc, increment
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
  
    const forumContainer = document.querySelector(".forum-container");
    const addBtn = document.querySelector(".add-post-btn");
    const novaBtn = document.querySelector(".botao-nova");
  
    let usuarioLogado = null;
  
    // criar post
    async function criarPost(titulo, conteudo) {
      const user = auth.currentUser;
      if (!user) { alert("Você precisa estar logado para postar."); return; }
      const usuarioSnap = await getDoc(doc(db, "usuarios", user.uid));
      const dadosUsuario = usuarioSnap.exists() ? usuarioSnap.data() : {};
      await addDoc(collection(db, "posts"), {
        autorId: user.uid,
        autorNome: dadosUsuario.nome || "Usuário",
        autorFoto: dadosUsuario.fotoURL || "./img/account_icon.png",
        titulo,
        conteudo,
        likes: 0,
        data: serverTimestamp()
      });
    }
  
    addBtn.addEventListener("click", () => {
      const titulo = prompt("Digite o título do post:");
      const conteudo = prompt("Escreva sua mensagem:");
      if (titulo && conteudo) criarPost(titulo, conteudo);
    });
  
    novaBtn.addEventListener("click", () => {
      const titulo = prompt("Título da publicação:");
      const conteudo = prompt("Conteúdo da publicação:");
      if (titulo && conteudo) criarPost(titulo, conteudo);
    });
  
    // render e updates em tempo real
    onAuthStateChanged(auth, (user) => {
      usuarioLogado = user;
  
      const q = query(collection(db, "posts"), orderBy("data", "desc"));
      onSnapshot(q, async (snapshot) => {
        forumContainer.innerHTML = `
          <div class="forum-search">
            <input type="text" placeholder="Pesquisar no fórum">
            <button class="add-post-btn">+</button>
          </div>
        `;
  
        snapshot.forEach((docSnap) => {
          const p = docSnap.data();
          const postId = docSnap.id;
          const dataFormatada = p.data?.toDate().toLocaleString("pt-BR") || "Agora";
  
          const linkPerfil = user && user.uid === p.autorId
            ? "perfil.html"
            : `perfilPessoa.html?uid=${p.autorId}`;
  
          forumContainer.innerHTML += `
            <div class="post-card com-brilho" data-id="${postId}">
              <h3 class="post-title">${escapeHtml(p.titulo)}</h3>
              <div class="post-meta">
                <img src="${escapeAttr(p.autorFoto)}" class="author-avatar">
                <div>
                  <span class="author-name">
                    <a href="${linkPerfil}">${escapeHtml(p.autorNome)}</a>
                  </span>
                  <span class="post-date">${dataFormatada}</span>
                </div>
              </div>
              <p class="post-content">${escapeHtml(p.conteudo)}</p>
  
              <div class="like-wrap" data-id="${postId}">
                <img src="./img/like_icon.png" alt="Curtir" class="like-icon">
                <span class="like-count">${p.likes || 0}</span>
              </div>
  
              <div class="post-actions">
                <img src="./img/consult_icon.png" alt="Comentários" class="comment-icon">
              </div>
            </div>
          `;
        });
  
        // depois de renderizar todos, ajustar ícones dos likes para o usuário logado
        if (usuarioLogado) {
          const cards = forumContainer.querySelectorAll(".post-card");
          cards.forEach(async (card) => {
            const id = card.dataset.id;
            const likeBtn = card.querySelector(".like-icon");
            const likeRef = doc(db, "posts", id, "likes", usuarioLogado.uid);
            const likeSnap = await getDoc(likeRef);
            if (likeSnap.exists()) likeBtn.src = "./img/like_curtido.png";
            else likeBtn.src = "./img/like_icon.png";
          });
        } else {
          // usuário não logado: mostra ícone padrão
          forumContainer.querySelectorAll(".like-icon").forEach(img => img.src = "./img/like_icon.png");
        }
      });
    });
  
    // util: escapar para evitar XSS quando for texto vindo do DB
    function escapeHtml(str) {
      if (!str) return "";
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }
    function escapeAttr(s){return escapeHtml(s);}
  
    // clique delegação: like toggle e abrir comentário (exceto like e nome)
    forumContainer.addEventListener("click", async (e) => {
      const card = e.target.closest(".post-card");
      if (!card) return;
  
      // clique no nome: não faz nada (link já existe)
      if (e.target.closest(".author-name a")) return;
  
      // clique no like
      const likeBtn = e.target.closest(".like-icon");
      if (likeBtn) {
        e.stopPropagation();
        if (!usuarioLogado) { alert("Você precisa estar logado para curtir."); return; }
  
        const wrap = likeBtn.closest(".like-wrap");
        const postId = wrap.getAttribute("data-id");
        const countEl = wrap.querySelector(".like-count");
        const current = parseInt(countEl.textContent, 10) || 0;
  
        const likeRef = doc(db, "posts", postId, "likes", usuarioLogado.uid);
        const likeSnap = await getDoc(likeRef);
  
        try {
          if (likeSnap.exists()) {
            // já curtiu -> descurtir
            await deleteDoc(likeRef);
            await updateDoc(doc(db, "posts", postId), { likes: increment(-1) });
  
            countEl.textContent = Math.max(0, current - 1);
            likeBtn.src = "./img/like_icon.png";
          } else {
            // curtir
            await setDoc(likeRef, { curtido: true });
            await updateDoc(doc(db, "posts", postId), { likes: increment(1) });
  
            countEl.textContent = current + 1;
            likeBtn.src = "./img/like_curtido.png";
          }
        } catch (err) {
          console.error("Erro ao (des)curtir:", err);
          alert("Erro ao processar like.");
        }
        return;
      }
  
      // clique no restante do card -> abrir comentResp
      if (!e.target.closest(".like-wrap")) {
        const postId = card.getAttribute("data-id");
        window.location.href = `comentResp.html?postId=${postId}`;
      }
    });
  </script>
  
</body>

</html>