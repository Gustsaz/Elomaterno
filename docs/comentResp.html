<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EloMaterno - Comentário</title>
  <link rel="stylesheet" href="./css/globals.css">
  <link rel="stylesheet" href="./css/header.css">
  <link rel="stylesheet" href="./css/coment.css">
  <link rel="icon" type="image/svg+xml" href="img/iconelogo.svg">
  <link rel="alternate icon" type="image/png" href="img/iconelogo.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

</head>

<body>

<svg aria-hidden="true" style="position: absolute; width: 0; height: 0; overflow: hidden;">
  <defs>
    <filter id="protanopia">
      <feColorMatrix type="matrix" values="
            0.567 0.433 0 0 0
            0.558 0.442 0 0 0
            0     0.242 0.758 0 0
            0     0     0     1 0" />
    </filter>
    <filter id="deuteranopia">
      <feColorMatrix type="matrix" values="
            0.625 0.375 0 0 0
            0.700 0.300 0 0 0
            0     0.300 0.700 0 0
            0     0     0     1 0" />
    </filter>
    <filter id="tritanopia">
      <feColorMatrix type="matrix" values="
            0.950 0.050 0     0 0
            0     0.433 0.567 0 0
            0     0.475 0.525 0 0
            0     0     0     1 0" />
    </filter>
    <filter id="Acromatopsia">
      <feColorMatrix type="matrix" values="
            0.299 0.587 0.114 0 0
            0.299 0.587 0.114 0 0
            0.299 0.587 0.114 0 0
            0     0     0     1 0" />
    </filter>
  </defs>
</svg>

<header class="top-header">
  <div class="left-section">
    <div class="logo-area">
      <a href="home.html" class="botao-link">
        <img src="./img/logo_icon.png" alt="Ícone Empresa" class="icon">
      </a>
      <span class="company-name">elomaterno</span>
    </div>

    <div class="search-box">
      <input type="text" id="global-search" placeholder="Pesquisar...">
      <button class="btn-search"><i class="fa fa-search"></i></button>
      <button class="btn-filter"><i class="fa fa-sliders"></i></button>

      <div id="filter-menu" class="filter-menu hidden">
        <label><input type="checkbox" value="todos" checked> Todos</label>
        <label><input type="checkbox" value="posts"> Posts</label>
        <label><input type="checkbox" value="artigos"> Artigos</label>
        <label><input type="checkbox" value="eventos"> Eventos</label>
        <label><input type="checkbox" value="perfis"> Perfis</label>
      </div>

      <div id="search-results" class="search-results hidden"></div>
    </div>

  </div>

  <div class="right-section">

    <div class="accessibility-selector">
      <button id="accessibility-toggle" aria-label="Opções de acessibilidade">
        <i class="fa fa-universal-access" aria-hidden="true"></i>
      </button>
      <ul id="accessibility-menu" class="hidden">
        <li id="increase-font">
          <i class="fa fa-plus-circle" aria-hidden="true"></i> Aumentar Fonte
        </li>
        <li id="decrease-font">
          <i class="fa fa-minus-circle" aria-hidden="true"></i> Diminuir Fonte
        </li>
        <li id="colorblind-filter">
          <i class="fa fa-low-vision" aria-hidden="true"></i> Filtros Daltonismo
        </li>
        <li id="screen-reader">
          <i class="fa fa-assistive-listening-systems" aria-hidden="true"></i> Leitura em Voz
        </li>
        <li id="reading-mask">
          <i class="fa fa-highlighter" aria-hidden="true"></i> Máscara de leitura
        </li>
        <li id="bold-text">
          <i class="fa fa-bold" aria-hidden="true"></i> Letras destacadas
        </li>
        <li id="high-contrast">
          <i class="fa fa-adjust" aria-hidden="true"></i> Alto contraste
        </li>
        <li id="increase-line">
          <i class="fa fa-arrows-alt-v" aria-hidden="true"></i> Aumentar Espaçamento Linhas
        </li>
        <li id="decrease-line">
          <i class="fa fa-compress-arrows-alt" aria-hidden="true"></i> Diminuir Espaçamento Linhas
        </li>
        <li id="reset-accessibility">
          <i class="fa fa-undo" aria-hidden="true"></i> Redefinir
        </li>
      </ul>
    </div>

    <div id="reading-mask-overlay">
      <div class="highlight-window"></div>
    </div>

    <div class="theme-toggle">
      <i class="fas fa-moon" id="theme-toggle-icon" aria-label="Alternar tema claro e escuro"></i>
    </div>

    <div class="logout-btn" id="logoutBtn" title="Sair da conta">
      <i class="fa fa-sign-out"></i>
    </div>
    <div class="user-avatar">
      <a href="perfil.html">
        <div class="avatar-loader-container">
          <img id="perfil-avatar">
          <div class="loader">
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
          </div>
        </div>
      </a>
    </div>
  </div>

</header>

<button id="menuToggle" class="menu-toggle">☰</button>

<div class="botoes">
  <div class="menu-user">
    <a href="perfil.html">
      <div class="avatar-loader-container">
        <img id="menu-avatar" src="./img/avatar_usuario.png" alt="Avatar do usuário">
        <div class="loader">
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
        </div>
      </div>
    </a>
    <h3 id="menu-nome">
      <div class="loader">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
    </h3>
    <span id="menu-email">
      <div class="loader">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
    </span>
  </div>

  <a href="consultoria.html" class="botao-link">
    <div class="botao-item">
      <i class="fa fa-comments"></i>
      <span>Consultorias</span>
    </div>
  </a>

  <a href="forum.html" class="botao-link">
    <div class="botao-item">
      <i class="fa fa-users"></i>
      <span>Fórum</span>
    </div>
  </a>

  <a href="home.html" class="botao-link home-btn">
    <div class="botao-item ativo">
      <i class="fa fa-home"></i>
      <span>Home</span>
    </div>
  </a>

  <a href="artigos.html" class="botao-link">
    <div class="botao-item">
      <i class="fa fa-book"></i>
      <span>Artigos</span>
    </div>
  </a>

  <a href="calendario.html" class="botao-link">
    <div class="botao-item">
      <i class="fa fa-calendar"></i>
      <span>Calendário</span>
    </div>
  </a>

  <a href="eventos.html" class="botao-link">
    <div class="botao-item">
      <i class="fa fa-bell"></i>
      <span>Eventos</span>
    </div>
  </a>

  <div class="menu-actions">
    <div class="theme-toggle mobile-toggle" id="menuThemeToggle">
      <i class="fas fa-moon" id="menu-theme-toggle-icon"></i>
    </div>
    <div class="logout-btn mobile-logout" id="menuLogoutBtn" title="Sair da conta">
      <i class="fa fa-sign-out"></i>
    </div>

    <div class="accessibility-selector">
      <button id="accessibility-toggle-mobile" aria-label="Opções de acessibilidade">
        <i class="fa fa-universal-access" aria-hidden="true"></i>
      </button>
      <ul id="accessibility-menu-mobile" class="hidden">
        <li data-action="increase-font"><i class="fa fa-plus-circle"></i> Aumentar Fonte</li>
        <li data-action="decrease-font"><i class="fa fa-minus-circle"></i> Diminuir Fonte</li>
        <li data-action="colorblind-filter"><i class="fa fa-low-vision"></i> Filtros Daltonismo</li>
        <li data-action="screen-reader"><i class="fa fa-assistive-listening-systems"></i> Leitura em Voz
        </li>
        <li data-action="reading-mask"><i class="fa fa-highlighter"></i> Máscara de leitura</li>
        <li data-action="bold-text"><i class="fa fa-bold"></i> Letras destacadas</li>
        <li data-action="high-contrast"><i class="fa fa-adjust"></i> Alto contraste</li>
        <li data-action="increase-line"><i class="fa fa-arrows-alt-v"></i> Aumentar Espaçamento Linhas</li>
        <li data-action="decrease-line"><i class="fa fa-compress-arrows-alt"></i> Diminuir Espaçamento
          Linhas</li>
        <li data-action="reset-accessibility"><i class="fa fa-undo"></i> Redefinir</li>
      </ul>

    </div>
  </div>

</div>

<main class="coment-container">

  <div class="post-card com-brilho" id="post-container"></div>

  <div class="comment-input">
    <input type="text" placeholder="Escreva seu comentário..." class="comment-field">
    <button class="send-btn">
      <img src="./img/send_icon.png" alt="Enviar">
    </button>
  </div>

  <div class="respostas"></div>
</main>

<button class="botao-nova">Nova Publicação</button>

<div class="modal" id="modal-edit-coment">
  <div class="modal-content">
    <h3>Editar Comentário</h3>
    <form id="form-edit-coment">
      <textarea id="edit-coment-text" rows="4"></textarea>
      <div class="modal-actions">
        <button type="button" id="cancelar-edit-coment">Cancelar</button>
        <button type="submit">Salvar</button>
      </div>
    </form>
  </div>
</div>

<div class="modal" id="modal-del-coment">
  <div class="modal-content">
    <h3>Confirmar Exclusão</h3>
    <p>Tem certeza que deseja excluir este comentário?</p>
    <div class="modal-actions">
      <button type="button" id="cancelar-del-coment">Cancelar</button>
      <button type="button" id="confirmar-del-coment">Excluir</button>
    </div>
  </div>
</div>

<script type="module">
  import { auth, db } from "./js/firebase.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
  import {
    doc, getDoc, collection, addDoc, serverTimestamp,
    query, orderBy, onSnapshot,
    setDoc, deleteDoc, updateDoc, increment
  } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

  const params = new URLSearchParams(window.location.search);
  const postId = params.get("postId");

  const postContainer = document.getElementById("post-container");
  const respostasContainer = document.querySelector(".respostas");
  const campoComentario = document.querySelector(".comment-field");
  const btnEnviar = document.querySelector(".send-btn");

  let usuarioLogado = null;
  let comentarioParaEditar = null;
  let comentarioParaExcluir = null;

  onAuthStateChanged(auth, (user) => {
    usuarioLogado = user;
    ajustarLikesVisuais();
  });

  async function carregarPost() {
    if (!postId) return;
    const snap = await getDoc(doc(db, "posts", postId));
    if (!snap.exists()) {
      postContainer.innerHTML = "<p>Post não encontrado.</p>";
      return;
    }

    const p = snap.data();
    document.title = `EloMaterno - ${p.titulo}`;
    const dataFormatada = p.data?.toDate().toLocaleString("pt-BR") || "Agora";

    let linkPerfil = "";
    if (p.autorId !== "anonimo") {
      linkPerfil = usuarioLogado && usuarioLogado.uid === p.autorId
        ? "perfil.html"
        : `perfilPessoa.html?uid=${p.autorId}`;
    }

    // buscar avatar atualizado do autor do post
    let autorFoto = p.autorFoto || "./img/account_icon.png";
    try {
      const autorSnap = await getDoc(doc(db, "usuarios", p.autorId));
      if (autorSnap.exists()) {
        const dadosAutor = autorSnap.data();
        if (dadosAutor.fotoURL) autorFoto = dadosAutor.fotoURL;
        else if (dadosAutor.avatar) autorFoto = dadosAutor.avatar;
      }
    } catch (err) {
      console.error("Erro ao buscar avatar do autor do post:", err);
    }

    postContainer.innerHTML = `
      <a href="forum.html" class="back-btn">
        <img src="./img/back_icon.png" alt="Voltar ao fórum">
      </a>
      <div class="post-header">
        <img src="${autorFoto}" alt="Avatar" class="post-avatar">
        <div class="post-info">
          <h4>
          ${p.autorId === "anonimo"
        ? "Anônimo"
        : `<a href="${linkPerfil}">${p.autorNome}</a>`}
          </h4>
          <span class="post-date">${dataFormatada}</span>
        </div>
      </div>
      <h2 class="post-title">${p.titulo}</h2>
      <p class="post-content">${p.conteudo}</p>

      <div class="like-wrap" data-type="post" data-id="${postId}">
        <img src="./img/like_icon.png" alt="Curtir" class="like-icon">
        <span class="like-count">${p.likes || 0}</span>
      </div>
    `;
    ajustarLikesVisuais();
  }

  function carregarComentarios() {
    const q = query(collection(db, "posts", postId, "comentarios"), orderBy("data", "asc"));

    onSnapshot(q, (snapshot) => {
      respostasContainer.innerHTML = "";
      snapshot.forEach(async (docSnap) => {
        const c = docSnap.data();
        const dataFormatada = c.data?.toDate().toLocaleString("pt-BR") || "Agora";

        const linkPerfil = usuarioLogado && usuarioLogado.uid === c.autorId
          ? "perfil.html"
          : `perfilPessoa.html?uid=${c.autorId}`;

        // buscar avatar atualizado do autor do comentário
        let autorFoto = c.autorFoto || "./img/account_icon.png";
        try {
          const autorSnap = await getDoc(doc(db, "usuarios", c.autorId));
          if (autorSnap.exists()) {
            const dadosAutor = autorSnap.data();
            if (dadosAutor.fotoURL) autorFoto = dadosAutor.fotoURL;
            else if (dadosAutor.avatar) autorFoto = dadosAutor.avatar;
          }
        } catch (err) {
          console.error("Erro ao buscar avatar do comentário:", err);
        }

        respostasContainer.innerHTML += `
          <div class="post-card resposta-card" data-id="${docSnap.id}">
            <div class="post-header">
              <img src="${autorFoto}" alt="Avatar" class="post-avatar">
              <div class="post-info">
                <h4><a href="${linkPerfil}">${c.autorNome}</a></h4>
                <span class="post-date">${dataFormatada}</span>
              </div>
            </div>
            <p class="post-content">${c.conteudo}</p>

            <div class="like-wrap" data-type="comentario" data-id="${docSnap.id}">
              <img src="./img/like_icon.png" alt="Curtir" class="like-icon">
              <span class="like-count">${c.likes || 0}</span>
            </div>

            ${usuarioLogado && usuarioLogado.uid === c.autorId ? `
              <div class="coment-actions">
                <button class="del-coment-btn">Excluir</button>
              </div>
            ` : ""}
          </div>
        `;
      });
      ajustarLikesVisuais();
    });
  }

  btnEnviar.addEventListener("click", async () => {
    const conteudo = campoComentario.value.trim();
    if (!conteudo) return;
    if (!usuarioLogado) {
      alert("Você precisa estar logado para comentar.");
      return;
    }

    const usuarioSnap = await getDoc(doc(db, "usuarios", usuarioLogado.uid));
    const dadosUsuario = usuarioSnap.exists() ? usuarioSnap.data() : {};

    let autorFoto = "./img/account_icon.png";
    if (dadosUsuario.fotoURL) autorFoto = dadosUsuario.fotoURL;
    else if (dadosUsuario.avatar) autorFoto = dadosUsuario.avatar;

    await addDoc(collection(db, "posts", postId, "comentarios"), {
      autorId: usuarioLogado.uid,
      autorNome: dadosUsuario.nome || "Usuário",
      autorFoto,
      conteudo,
      likes: 0,
      data: serverTimestamp()
    });
    campoComentario.value = "";
  });

  document.body.addEventListener("click", async (e) => {
    const likeBtn = e.target.closest(".like-icon");
    if (!likeBtn) return;
    if (!usuarioLogado) { alert("Você precisa estar logado para curtir."); return; }

    const wrap = likeBtn.closest(".like-wrap");
    const tipo = wrap.getAttribute("data-type");
    const id = wrap.getAttribute("data-id");
    const countEl = wrap.querySelector(".like-count");
    const current = parseInt(countEl.textContent, 10) || 0;

    try {
      if (tipo === "post") {
        const likeRef = doc(db, "posts", postId, "likes", usuarioLogado.uid);
        const likeSnap = await getDoc(likeRef);
        if (likeSnap.exists()) {
          await deleteDoc(likeRef);
          await updateDoc(doc(db, "posts", postId), { likes: increment(-1) });
          countEl.textContent = Math.max(0, current - 1);
          likeBtn.src = "./img/like_icon.png";
        } else {
          await setDoc(likeRef, { curtido: true });
          await updateDoc(doc(db, "posts", postId), { likes: increment(1) });
          countEl.textContent = current + 1;
          likeBtn.src = "./img/like_curtido.png";
        }
      } else if (tipo === "comentario") {
        const likeRef = doc(db, "posts", postId, "comentarios", id, "likes", usuarioLogado.uid);
        const likeSnap = await getDoc(likeRef);
        if (likeSnap.exists()) {
          await deleteDoc(likeRef);
          await updateDoc(doc(db, "posts", postId, "comentarios", id), { likes: increment(-1) });
          countEl.textContent = Math.max(0, current - 1);
          likeBtn.src = "./img/like_icon.png";
        } else {
          await setDoc(likeRef, { curtido: true });
          await updateDoc(doc(db, "posts", postId, "comentarios", id), { likes: increment(1) });
          countEl.textContent = current + 1;
          likeBtn.src = "./img/like_curtido.png";
        }
      }
    } catch (err) { console.error("Erro ao curtir:", err); }
  });

  respostasContainer.addEventListener("click", async (e) => {
    const card = e.target.closest(".resposta-card");
    if (!card) return;
    const comentId = card.dataset.id;

    if (e.target.classList.contains("edit-coment-btn")) {
      comentarioParaEditar = comentId;
      const snap = await getDoc(doc(db, "posts", postId, "comentarios", comentId));
      if (snap.exists()) {
        document.getElementById("edit-coment-text").value = snap.data().conteudo;
        document.getElementById("modal-edit-coment").style.display = "flex";
      }
    }

    if (e.target.classList.contains("del-coment-btn")) {
      comentarioParaExcluir = comentId;
      document.getElementById("modal-del-coment").style.display = "flex";
    }
  });

  document.getElementById("form-edit-coment").addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!comentarioParaEditar) return;
    const novoTexto = document.getElementById("edit-coment-text").value.trim();
    if (!novoTexto) return;

    await updateDoc(doc(db, "posts", postId, "comentarios", comentarioParaEditar), {
      conteudo: novoTexto
    });

    comentarioParaEditar = null;
    document.getElementById("modal-edit-coment").style.display = "none";
  });

  document.getElementById("cancelar-edit-coment").addEventListener("click", () => {
    comentarioParaEditar = null;
    document.getElementById("modal-edit-coment").style.display = "none";
  });

  document.getElementById("confirmar-del-coment").addEventListener("click", async () => {
    if (comentarioParaExcluir) {
      await deleteDoc(doc(db, "posts", postId, "comentarios", comentarioParaExcluir));
      comentarioParaExcluir = null;
    }
    document.getElementById("modal-del-coment").style.display = "none";
  });

  document.getElementById("cancelar-del-coment").addEventListener("click", () => {
    comentarioParaExcluir = null;
    document.getElementById("modal-del-coment").style.display = "none";
  });

  async function ajustarLikesVisuais() {
    if (!usuarioLogado) return;

    const postLikeImg = document.querySelector('#post-container .like-icon');
    if (postLikeImg) {
      const likeRef = doc(db, "posts", postId, "likes", usuarioLogado.uid);
      const s = await getDoc(likeRef);
      postLikeImg.src = s.exists() ? "./img/like_curtido.png" : "./img/like_icon.png";
    }

    const commentLikeImgs = document.querySelectorAll('.respostas .like-wrap');
    for (const wrap of commentLikeImgs) {
      const img = wrap.querySelector(".like-icon");
      const comentId = wrap.getAttribute('data-id');
      const likeRef = doc(db, "posts", postId, "comentarios", comentId, "likes", usuarioLogado.uid);
      const s = await getDoc(likeRef);
      img.src = s.exists() ? "./img/like_curtido.png" : "./img/like_icon.png";
    }
  }

  carregarPost();
  carregarComentarios();
</script>


<script type="module" src="./js/globals.js"></script>
<script type="module" src="./js/pesquisa.js"></script>
<script type="module" src="./js/carregar-avatar.js"></script>

</body>

</html>